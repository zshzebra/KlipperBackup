# TMC2130 Sensorless Homing Debug Configuration
# Include this in your printer.cfg with: [include sensorless_debug.cfg]

[gcode_macro TMC_DEBUG]
description: Read TMC2130 registers for debugging
gcode:
    # Read important TMC2130 registers
    DUMP_TMC STEPPER=stepper_x
    DUMP_TMC STEPPER=stepper_y
    
[gcode_macro TEST_STALLGUARD]
description: Test stallguard sensitivity with current SGT values
gcode:
    # Save current position
    G91  # Relative positioning
    
    # Test X axis
    RESPOND MSG="Testing X axis stallguard..."
    DUMP_TMC STEPPER=stepper_x
    G4 P500
    
    # Try a small move to see register changes
    SET_TMC_FIELD STEPPER=stepper_x FIELD=tcoolthrs VALUE=1048575  # Max value = always detect
    G1 X-1 F600  # Very slow move
    DUMP_TMC STEPPER=stepper_x
    
    # Test Y axis  
    RESPOND MSG="Testing Y axis stallguard..."
    DUMP_TMC STEPPER=stepper_y
    G4 P500
    
    SET_TMC_FIELD STEPPER=stepper_y FIELD=tcoolthrs VALUE=1048575
    G1 Y-1 F600
    DUMP_TMC STEPPER=stepper_y
    
    G90  # Back to absolute

[gcode_macro TEST_SGT_VALUES]
description: Test different SGT values to find optimal sensitivity
variable_sgt_test: 0
gcode:
    {% set SGT = params.SGT|default(3)|int %}
    {% set AXIS = params.AXIS|default('X')|upper %}
    
    {% if AXIS == 'X' %}
        {% set STEPPER = 'stepper_x' %}
    {% elif AXIS == 'Y' %}
        {% set STEPPER = 'stepper_y' %}
    {% else %}
        RESPOND MSG="Invalid axis. Use X or Y"
        {% set STEPPER = '' %}
    {% endif %}
    
    {% if STEPPER %}
        RESPOND MSG="Testing {AXIS} axis with SGT={SGT}"
        SET_TMC_FIELD STEPPER={STEPPER} FIELD=sgt VALUE={SGT}
        
        # Enable stallguard detection
        SET_TMC_FIELD STEPPER={STEPPER} FIELD=tcoolthrs VALUE=1048575
        SET_TMC_FIELD STEPPER={STEPPER} FIELD=diag1_stall VALUE=1
        
        # Read current state
        DUMP_TMC STEPPER={STEPPER}
        
        G91
        G4 P250
        
        # Try small move - should trigger if sensitive enough
        G1 {AXIS}-5 F1200
        
        # Check status after move
        DUMP_TMC STEPPER={STEPPER}
        G90
    {% endif %}

[gcode_macro STALLGUARD_SENSITIVITY_SWEEP]
description: Test SGT values from 0 to 63 to find trigger point
gcode:
    {% set AXIS = params.AXIS|default('X')|upper %}
    {% set START = params.START|default(0)|int %}
    {% set END = params.END|default(20)|int %}
    {% set STEP = params.STEP|default(2)|int %}
    
    RESPOND MSG="Starting stallguard sensitivity sweep on {AXIS} axis from SGT={START} to {END}"
    
    {% for sgt in range(START, END + 1, STEP) %}
        TEST_SGT_VALUES AXIS={AXIS} SGT={sgt}
        G4 P1000  # Wait between tests
    {% endfor %}
    
    RESPOND MSG="Sweep complete. Check which SGT values triggered."

[gcode_macro CHECK_TMC_CONNECTION]
description: Verify TMC2130 SPI communication
gcode:
    # This will read the GSTAT register and check for errors
    RESPOND MSG="Checking TMC2130 connections..."
    
    RESPOND MSG="X Axis TMC2130:"
    DUMP_TMC STEPPER=stepper_x REGISTER=GSTAT
    DUMP_TMC STEPPER=stepper_x REGISTER=GCONF
    DUMP_TMC STEPPER=stepper_x REGISTER=DRV_STATUS
    
    RESPOND MSG="Y Axis TMC2130:"
    DUMP_TMC STEPPER=stepper_y REGISTER=GSTAT
    DUMP_TMC STEPPER=stepper_y REGISTER=GCONF  
    DUMP_TMC STEPPER=stepper_y REGISTER=DRV_STATUS

[gcode_macro MANUAL_STALLGUARD_TEST]
description: Manually trigger stallguard by hand-blocking axis
gcode:
    {% set AXIS = params.AXIS|default('X')|upper %}
    
    {% if AXIS == 'X' %}
        {% set STEPPER = 'stepper_x' %}
    {% elif AXIS == 'Y' %}
        {% set STEPPER = 'stepper_y' %}
    {% else %}
        RESPOND MSG="Invalid axis. Use X or Y"
        {% set STEPPER = '' %}
    {% endif %}
    
    {% if STEPPER %}
        RESPOND MSG="Manual stallguard test for {AXIS} axis"
        RESPOND MSG="MANUALLY BLOCK THE AXIS DURING THE MOVE!"
        
        # Set very sensitive SGT
        SET_TMC_FIELD STEPPER={STEPPER} FIELD=sgt VALUE=1
        SET_TMC_FIELD STEPPER={STEPPER} FIELD=tcoolthrs VALUE=1048575
        
        G91
        G4 P3000  # Give user time to prepare
        
        RESPOND MSG="Starting move now - BLOCK IT!"
        G1 {AXIS}-50 F600  # Slow 50mm move
        
        RESPOND MSG="Move complete. Checking if stallguard triggered:"
        DUMP_TMC STEPPER={STEPPER}
        G90
    {% endif %}

[gcode_macro FIX_SENSORLESS_CONFIG]
description: Apply potential fixes for sensorless homing
gcode:
    RESPOND MSG="Applying sensorless homing fixes..."
    
    # Ensure DIAG1 is enabled for stallguard output
    SET_TMC_FIELD STEPPER=stepper_x FIELD=diag1_stall VALUE=1
    SET_TMC_FIELD STEPPER=stepper_y FIELD=diag1_stall VALUE=1
    
    # Set TCOOLTHRS to always enable stallguard
    SET_TMC_FIELD STEPPER=stepper_x FIELD=tcoolthrs VALUE=1048575
    SET_TMC_FIELD STEPPER=stepper_y FIELD=tcoolthrs VALUE=1048575
    
    # Disable StealthChop (force SpreadCycle) for testing
    SET_TMC_FIELD STEPPER=stepper_x FIELD=en_pwm_mode VALUE=0
    SET_TMC_FIELD STEPPER=stepper_y FIELD=en_pwm_mode VALUE=0
    
    # Set moderate SGT values
    SET_TMC_FIELD STEPPER=stepper_x FIELD=sgt VALUE=6
    SET_TMC_FIELD STEPPER=stepper_y FIELD=sgt VALUE=8
    
    RESPOND MSG="Configuration applied. Try homing now."
    DUMP_TMC STEPPER=stepper_x
    DUMP_TMC STEPPER=stepper_y